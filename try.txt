@model NotifApps.Models.Equipe

@{
    ViewData["Title"] = "Créer une Équipe";
}

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.0.0-beta.1/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
</head>

<div class="container mt-5">
    <div class="card card">
        <div class="card-header bg-black d-flex justify-content-lg-between text-white">
            <h4> Créer une nouvelle équipe</h4>
            <span><i class="fas fa-info-circle"></i></span>
        </div>
        <div class="card-body">
            <form asp-action="Create" method="post">
                <div class="form-group">
                    <label asp-for="NomEquipe" class="control-label"></label>
                    <input asp-for="NomEquipe" class="form-control" placeholder="Entrez un nom" />
                    <span asp-validation-for="NomEquipe" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label asp-for="Descriptions" class="form-label">Description</label>
                    <textarea asp-for="Descriptions" class="form-control" placeholder="Ajoutez une description si nécessaire"></textarea>
                    <span asp-validation-for="Descriptions" class="text-danger"></span>
                </div>

                <div class="form-group mt-3">
                    <label>Souhaitez-vous rattacher des utilisateurs à cette équipe ?</label>
                    <div>
                        <button type="button" class="btn btn-primary" onclick="showUserForm()">Oui</button>
                        <button type="button" class="btn btn-secondary" onclick="hideUserForm()">Non</button>
                    </div>
                </div>

                <div id="userForm" style="display:none;">
                    <h5>Rattacher Utilisateur(s)</h5>
                    <input type="text" id="searchInput" class="form-control" placeholder="Rechercher un utilisateur" onkeyup="filterUsers()" />
                    <div id="search-results" class="mt-3"></div>
                    <div id="selected-users" class="row mt-3"></div>
                </div>

                <div class="d-flex justify-content-center mt-4">
                    <button type="submit" class="btn btn-danger ms-3" title="Créer"><i class="fas fa-save"></i> Enregistrer</button>
                    <a asp-action="Index" class="btn btn-black ms-3" title="Annuler"><i class="fas fa-ban"></i> Annuler</a>
                </div>
            </form>
        </div>
    </div>
</div>

@if (ViewBag.ExistingEquipe != null && (bool)ViewBag.ExistingEquipe)
{
    <div class="modal fade show" tabindex="-1" role="dialog" style="display: block; top: 0;" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-warning-subtle border-black">
                    <h5 class="modal-title">Duplication détectée</h5>
                    <i class="fas fa-exclamation-triangle ms-4"></i>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="closeModal()">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body bg-light-subtle">
                    <p>L'equipe avec le nom <strong>@ViewBag.NomEquipe</strong> existe déjà. Voulez-vous continuer ?</p>
                </div>
                <div class="modal-footer bg-warning-subtle">
                    <form asp-action="Create" method="post">
                        <input type="hidden" name="NomEquipe" value="@ViewBag.NomEquipe" />
                        <input type="hidden" name="forceCreate" value="true" />
                        <button type="submit" class="btn btn-danger">Oui</button>
                    </form>
                    <a asp-action="Index" class="btn btn-black ms-3" title="Retour"><i class="fas fa-ban"></i> Annuler</a>
                </div>
            </div>
        </div>
    </div>
}

<script>
    function closeModal() {
        document.querySelector('.modal').style.display = 'none';
    }
</script>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            // Afficher le formulaire des utilisateurs
            window.showUserForm = function() {
                document.getElementById('userForm').style.display = 'block';
            }

            // Masquer le formulaire des utilisateurs
            window.hideUserForm = function() {
                document.getElementById('userForm').style.display = 'none';
            }

            // Filtrer les utilisateurs
            window.filterUsers = function() {
                var input, filter, userList, i, txtValue;
                input = document.getElementById('searchInput');
                filter = input.value.toLowerCase();
                userList = document.getElementById("search-results");
                userList.innerHTML = '';

                if (filter.length > 2) {
                    $.ajax({
                        url: '@Url.Action("Search", "Equipes")',
                        type: 'GET',
                        data: { query: filter },
                        success: function (data) {
                            data.forEach(function (utilisateur) {
                                const html = `
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input add-user" id="nouveau_utilisateur_${utilisateur.utilisateursId}" data-id="${utilisateur.utilisateursId}" data-nom="${utilisateur.nomUtilisateurs}" data-prenom="${utilisateur.prenomUtilisateurs}" />
                                        <label class="form-check-label" for="nouveau_utilisateur_${utilisateur.utilisateursId}">
                                            ${utilisateur.nomUtilisateurs} ${utilisateur.prenomUtilisateurs}
                                        </label>
                                    </div>`;
                                userList.innerHTML += html;
                            });
                        },
                        error: function () {
                            userList.innerHTML = '<p class="text-danger">Erreur lors de la recherche.</p>';
                        }
                    });
                }
            }

            // Ajouter un utilisateur sélectionné
            $(document).on('change', '.add-user', function () {
                if ($(this).is(':checked')) {
                    const userId = $(this).data('id');
                    const userNom = $(this).data('nom');
                    const userPrenom = $(this).data('prenom');
                    const html = `
                        <div class="col-sm-2 selected-user" data-id="${userId}">
                            <span>${userNom} ${userPrenom}</span>
                            <button type="button" class="btn btn-danger btn-sm remove-user" data-id="${userId}">X</button>
                            <input type="hidden" name="selectedUsers" value="${userId}" />
                        </div>`;
                    $('#selected-users').append(html);
                }
            });

            // Supprimer un utilisateur sélectionné
            $(document).on('click', '.remove-user', function () {
                const userId = $(this).data('id');
                $(`.selected-user[data-id="${userId}"]`).remove();
                $(`#nouveau_utilisateur_${userId}`).prop('checked', false);
            });
        });
    </script>
}

<style>
    .card {
        border-top-color: red;
        border-top-style: solid;
        border-top-width: 5px;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
    }

    .selected-user {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 5px;
        border: 1px solid #ddd;
        margin-bottom: 10px;
        border-radius: 5px;
    }

        .selected-user span {
            flex-grow: 1;
        }

        .selected-user button {
            margin-left: 10px;
        }
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script>
        $(document).ready(function () {
            $('form').on('submit', function (e) {
                if ($('input[name="forceCreate"]').length === 0) {
                    e.preventDefault(); // Empêche le formulaire de se soumettre normalement

                    var form = $(this);
                    $.ajax({
                        type: form.attr('method'),
                        url: form.attr('action'),
                        data: form.serialize(),
                        success: function (response) {
                            if (response.exists) {
                                var confirmCreate = confirm("L'équipe avec le nom " + response.nomEquipe + " existe déjà. Voulez-vous continuer ?");
                                if (confirmCreate) {
                                    $('<input>').attr({
                                        type: 'hidden',
                                        name: 'forceCreate',
                                        value: 'true'
                                    }).appendTo(form);
                                    form.off('submit').submit(); // Soumet le formulaire normalement
                                }
                            } else if (response.success) {
                                window.location.href = '@Url.Action("Index", "Equipes")';
                            }
                        }
                    });
                }
            });
        });
</script>
